<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>‰ªä‰∫à's Homepage - Neural Link</title>
    <link rel="icon" type="image/jpeg" href="https://s2.loli.net/2024/08/14/UuaJ1elnkKgGChN.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js"></script>

    <style>
        @font-face { font-family: "sakura"; src: url("./sakura.min.ttf") format("truetype"); }

        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden;
            background: linear-gradient(125deg, #0f0c29, #302b63, #24243e, #1b2735, #090a0f);
            background-size: 400% 400%;
            animation: aurora 20s ease infinite;
            font-family: 'sakura', sans-serif;
            user-select: none; -webkit-user-select: none;
            -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; touch-action: none;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        canvas#startrack { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }

        /* --- üì∑ ÊëÑÂÉèÂ§¥‰∏éÈ™®È™ºÁªòÂà∂ÂÆπÂô® --- */
        .camera-box {
            position: fixed; bottom: 20px; left: 20px; width: 160px; height: 120px;
            border: 1px solid rgba(80, 255, 255, 0.3); border-radius: 8px;
            z-index: 900; overflow: hidden; opacity: 0; pointer-events: none; transition: opacity 0.5s;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); background: rgba(0,0,0,0.5);
        }
        .camera-box.active { opacity: 1; }
        
        /* ËßÜÈ¢ëÂíåÈ™®È™ºÁîªÂ∏ÉÈáçÂè† */
        #input_video, #overlay_canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: scaleX(-1); /* ÈïúÂÉèÁøªËΩ¨ÔºåÁ¨¶ÂêàÁõ¥Ëßâ */
            object-fit: cover;
        }
        #input_video { opacity: 0.6; } /* ËßÜÈ¢ëÁ®çÂæÆÊöó‰∏ÄÁÇπÔºåÁ™ÅÂá∫È™®È™º */

        #loading-bar { position: fixed; top: 0; left: 0; height: 3px; background: #50ffff; width: 0%; z-index: 2000; transition: width 0.3s; box-shadow: 0 0 10px #50ffff; }

        .main { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 10; perspective: 1200px; opacity: 0; transition: opacity 1s ease-in; pointer-events: none; }
        .main.loaded { opacity: 1; }

        /* ÁéªÁíÉÂç°Áâá */
        .glass-card {
            position: relative; pointer-events: auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px; padding: 50px 80px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s ease-out;
            max-width: 90%; box-sizing: border-box;
        }

        .avatar-container { position: relative; width: 130px; height: 130px; margin-bottom: 25px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.3s; pointer-events: auto; }
        .avatar-container:hover { transform: scale(1.05); }
        .avatar-container:active { transform: scale(0.95); }
        .avatar-img { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.9); box-shadow: 0 0 30px rgba(255, 200, 245, 0.6); z-index: 2; transition: transform 1s; }
        .spin-warp { animation: warpSpin 1s cubic-bezier(0.5, 0, 0.5, 1) forwards; }
        .orbit-ring { position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; border: 2px dashed rgba(255, 200, 245, 0.3); animation: spin 20s linear infinite; transition: all 0.5s; }
        .warp-active .orbit-ring { border-color: #50ffff; box-shadow: 0 0 50px #50ffff; animation: spin 0.5s linear infinite; }
        .warp-active .avatar-img { border-color: #50ffff; box-shadow: 0 0 50px #50ffff; }

        .name { font-size: 2.8rem; color: #fff; text-shadow: 0 0 15px rgba(255, 100, 200, 0.8); margin-bottom: 10px; text-align: center; font-weight: bold; letter-spacing: 2px; white-space: nowrap; }
        .role { font-size: 0.9rem; color: rgba(220, 230, 255, 0.8); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 35px; text-align: center; display: flex; flex-direction: row; gap: 8px; justify-content: center; }
        .separator { color: #ff64c8; }
        .btns { display: flex; gap: 25px; pointer-events: auto; flex-direction: row; }
        .btn { position: relative; padding: 12px 36px; border-radius: 50px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.25); color: #ffc8f5; text-decoration: none; font-size: 1.2rem; overflow: hidden; transition: all 0.3s; cursor: pointer; white-space: nowrap; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        .btn:hover { background: rgba(255, 200, 245, 0.2); box-shadow: 0 0 25px rgba(255, 100, 200, 0.5); border-color: #ffc8f5; transform: translateY(-3px); color: #fff; }
        .btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: skewX(-20deg); animation: shine 4s infinite; }

        /* Âè≥‰∏ãËßíÊéßÂà∂Âå∫ */
        .hint-corner {
            position: fixed; bottom: 20px; right: 25px; z-index: 50; 
            display: flex; align-items: center; justify-content: flex-end; gap: 20px;
            opacity: 0; transition: opacity 1s; pointer-events: none;
        }
        .hint-corner.show { opacity: 1; }

        .icon-btn {
            font-size: 24px; color: rgba(255, 255, 255, 0.4);
            cursor: pointer; transition: all 0.3s ease;
            text-shadow: 0 0 5px rgba(0,0,0,0.5); pointer-events: auto;
        }
        .icon-btn:hover { color: #fff; transform: scale(1.2); text-shadow: 0 0 15px #50ffff; }
        .icon-btn.active { color: #50ffff; text-shadow: 0 0 20px #50ffff; transform: scale(1.1); }

        .kb-group { position: relative; display: flex; align-items: center; pointer-events: auto; }
        .hint-box {
            position: absolute; right: 100%; top: 50%; transform: translateY(-50%) translateX(10px); margin-right: 15px;
            background: rgba(0, 20, 40, 0.9); border: 1px solid rgba(80, 255, 255, 0.3);
            padding: 8px 12px; border-radius: 8px; color: #50ffff; font-family: 'Courier New', monospace; font-size: 12px;
            opacity: 0; transition: all 0.3s; white-space: nowrap; pointer-events: none;
        }
        .kb-group:hover .hint-box, .hint-box.typing-active { opacity: 1; transform: translateY(-50%) translateX(0); }

        kbd { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 3px; padding: 2px 4px; margin: 0 2px; font-weight: bold; transition: all 0.1s; }
        kbd.active { background: #50ffff; color: #000; box-shadow: 0 0 10px #50ffff; }

        /* UI Common */
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); border: 1px solid #50ffff; color: #50ffff; padding: 10px 20px; border-radius: 5px; opacity: 0; transition: opacity 0.5s; pointer-events: none; font-family: monospace; z-index: 100; white-space: nowrap; }
        #toast.show { opacity: 1; }
        #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; font-family: monospace; cursor: pointer; }
        .terminal-text { color: #50ffff; font-size: 14px; line-height: 1.6; text-shadow: 0 0 5px #50ffff; padding: 20px; max-width: 600px; }
        .system-off { animation: tvOff 0.6s ease-in-out forwards; pointer-events: none; }
        @keyframes tvOff { 0% { transform: scale(1); opacity: 1; } 100% { transform: scaleY(0.005) scaleX(0); opacity: 0; } }
        .highlight { color: #ffc8f5; font-weight: bold; }
        .blink { animation: blink 1s infinite; } @keyframes blink { 50% { opacity: 0; } }
        @keyframes spin { 100% { transform: rotate(360deg); } } @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } } @keyframes warpSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(1080deg); } }

        /* Âè≥ÈîÆËèúÂçï */
        #context-menu { position: fixed; top: 0; left: 0; width: 160px; height: 160px; border-radius: 50%; pointer-events: none; z-index: 999; opacity: 0; transform: scale(0.5); transition: opacity 0.2s, transform 0.2s; display: flex; justify-content: center; align-items: center; }
        #context-menu.visible { opacity: 1; transform: scale(1); pointer-events: auto; }
        .ctx-center { position: absolute; width: 10px; height: 10px; background: #50ffff; border-radius: 50%; box-shadow: 0 0 10px #50ffff; }
        .ctx-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 1px dashed rgba(80, 255, 255, 0.3); animation: spin 10s linear infinite; }
        .ctx-item { position: absolute; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; background: rgba(0, 20, 40, 0.8); border: 1px solid rgba(80, 255, 255, 0.4); border-radius: 50%; color: #50ffff; font-family: monospace; font-size: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .ctx-item:hover { background: #50ffff; color: #000; box-shadow: 0 0 20px #50ffff; transform: scale(1.1); }
        .ctx-top { top: 0; } .ctx-bottom { bottom: 0; } .ctx-left { left: 0; } .ctx-right { right: 0; }

        .speed-hud { position: fixed; bottom: 20px; left: 25px; z-index: 50; font-family: monospace; color: rgba(255,255,255,0.5); font-size: 12px; pointer-events: none; display: flex; flex-direction: column; gap: 5px; opacity: 0; transition: opacity 1s; }
        .speed-hud.show { opacity: 1; }
        .speed-bar-container { width: 150px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .speed-bar { height: 100%; background: #50ffff; width: 50%; transition: width 0.1s linear, background 0.3s; box-shadow: 0 0 5px #50ffff; }

        /* ÁßªÂä®Á´Ø */
        @media (max-width: 700px) {
            .glass-card { width: 85%; padding: 40px 20px; max-height: 90vh; overflow-y: auto; }
            .name { font-size: 2rem; }
            .role { flex-direction: column; gap: 5px; }
            .separator { display: none; }
            .btns { flex-direction: column; width: 100%; gap: 15px; }
            .btn { width: 100%; text-align: center; }
            .hint-corner { right: 15px; bottom: 15px; }
            .kb-group, .speed-hud, #context-menu { display: none !important; } 
        }
    </style>
</head>
<body>

    <canvas id="startrack"></canvas>
    
    <div class="camera-box" id="camera-box">
        <video id="input_video" autoplay playsinline></video>
        <canvas id="overlay_canvas"></canvas>
    </div>

    <div id="loading-bar"></div>
    <div id="boot-screen"><div class="terminal-text" id="terminal-content"></div></div>
    <div id="toast">SYSTEM: Warp Drive Engaged!</div>

    <div class="main" id="main-content">
        <div class="glass-card" id="tilt-card">
            <div class="avatar-container" id="avatar-btn">
                <div class="orbit-ring" id="orbit-ring"></div>
                <img src="https://s2.loli.net/2024/08/14/UuaJ1elnkKgGChN.jpg" class="avatar-img" id="avatar-img" alt="Â§¥ÂÉè">
            </div>
            <div class="name">ÂòéÂòésama | ‰ªä‰∫à</div>
            <div class="role">
                <span>Zhejiang University</span>
                <span class="separator">|</span>
                <span>Mechanical Engineering</span>
            </div>
            <div class="btns">
                <a href="https://notion-next-is5zr145w-hjys-projects-4f1ab78d.vercel.app/" target="_blank" class="btn">ÂçöÂÆ¢</a>
                <a href="https://github.com/JYbestow" target="_blank" class="btn">Github</a>
                <a href="https://space.bilibili.com/402611949?spm_id_from=333.1007.0.0" target="_blank" class="btn">bilibili</a>
            </div>
        </div>
    </div>

    <div class="speed-hud" id="ui-hud">
        <div class="hud-text" id="speed-text">TIME: 1.0x</div>
        <div class="speed-bar-container"><div class="speed-bar" id="speed-bar"></div></div>
    </div>

    <div class="hint-corner" id="ui-hint">
        <div class="kb-group">
            <div class="hint-box" id="konami-hint">Code: <kbd>‚Üë</kbd><kbd>‚Üë</kbd><kbd>‚Üì</kbd><kbd>‚Üì</kbd><kbd>‚Üê</kbd><kbd>‚Üí</kbd><kbd>‚Üê</kbd><kbd>‚Üí</kbd><kbd>B</kbd><kbd>A</kbd></div>
            <div class="icon-btn" id="kb-icon">‚å®Ô∏è</div>
        </div>
        <div class="icon-btn" id="hand-btn" title="Toggle Hand Control">üñêÔ∏è</div>
    </div>

    <div id="context-menu">
        <div class="ctx-ring"></div><div class="ctx-center"></div>
        <div class="ctx-item ctx-top" id="ctx-warp">WARP</div>
        <div class="ctx-item ctx-right" id="ctx-rgb">RGB</div>
        <div class="ctx-item ctx-bottom" id="ctx-reset">RESET</div>
        <div class="ctx-item ctx-left" id="ctx-freeze">FREEZE</div>
    </div>

    <script>
        console.log("%c Hello ZJU Engineer!", "font-size: 20px; color: #50ffff;");
        window.requestAnimFrame = (function() { return window.requestAnimationFrame || function(callback) { window.setTimeout(callback, 1000 / 60); }; })();
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 700;

        $(function() {
            // --- ÂºïÂØº ---
            let cmdLines = ["> [SCROLL] : TIME DILATION", "> [HOLD]   : SINGULARITY"];
            if (!isMobile) { cmdLines.push("> [RIGHT CLICK] : TACTICAL MENU"); cmdLines.push("> [HAND]   : GOD MODE"); } 
            else { cmdLines.push("> [TAP AVATAR] : WARP DRIVE"); }
            const lines = ["INITIALIZING PHYSICS ENGINE...", "LOADING NEURAL NETWORK... [OK]", "--------------------------------", "COMMANDS:", ...cmdLines, "--------------------------------", "CLICK TO START <span class='blink'>_</span>"];
            const term = document.getElementById('terminal-content');
            let lIdx = 0, cIdx = 0;
            function type() {
                if(lIdx < lines.length) {
                    if(lIdx === lines.length - 1) { term.innerHTML += `<div class='cmd-line highlight'>${lines[lIdx]}</div>`; lIdx++; } 
                    else {
                        if(cIdx===0) term.innerHTML += `<div class='cmd-line' id='l-${lIdx}'></div>`;
                        document.getElementById('l-'+lIdx).textContent += lines[lIdx].charAt(cIdx); cIdx++;
                        if(cIdx < lines[lIdx].length) setTimeout(type, 15); else { cIdx=0; lIdx++; setTimeout(type, 50); }
                    }
                }
            }
            setTimeout(type, 500);
            
            function closeBoot() {
                document.getElementById('boot-screen').classList.add('system-off');
                document.getElementById('main-content').classList.add('loaded');
                setTimeout(() => { document.getElementById('ui-hint').classList.add('show'); document.getElementById('ui-hud').classList.add('show'); }, 800);
            }
            document.getElementById('boot-screen').addEventListener('click', closeBoot);
            document.getElementById('boot-screen').addEventListener('touchstart', closeBoot);

            // --- Canvas Core ---
            const canvas = document.getElementById('startrack');
            const ctx = canvas.getContext('2d');
            let cw, ch;
            function resize() { 
                cw = window.innerWidth; ch = window.innerHeight; 
                const dpr = isMobile ? 1 : Math.min(window.devicePixelRatio, 2); 
                canvas.width = cw * dpr; canvas.height = ch * dpr;
                ctx.scale(dpr, dpr);
            }
            resize(); window.addEventListener('resize', resize);

            let mx = 0, my = 0, rawMx = 0, rawMy = 0;
            function updateCoords(x, y) { rawMx = x; rawMy = y; mx = (x - cw/2)/cw; my = (y - ch/2)/ch; 
                const c = document.getElementById('tilt-card'); if(c) c.style.transform = `perspective(1000px) rotateX(${-my*15}deg) rotateY(${mx*15}deg)`; }
            document.addEventListener('mousemove', e=>updateCoords(e.clientX, e.clientY));
            document.addEventListener('touchmove', e=>{if(e.touches.length) updateCoords(e.touches[0].clientX, e.touches[0].clientY);});

            // Áä∂ÊÄÅ
            let globalSpeed=1.0, warpSpeed=1.0, isWarping=false, rainbowMode=false, isSucking=false, handExpansion=0, targetExpansion=0;

            // --- Hand Control (PC Only) ---
            if (!isMobile) {
                const videoElement = document.getElementById('input_video');
                const overlayCanvas = document.getElementById('overlay_canvas');
                const ctxOverlay = overlayCanvas.getContext('2d');
                const handBtn = document.getElementById('hand-btn');
                const cameraBox = document.getElementById('camera-box');
                const loadingBar = document.getElementById('loading-bar');
                let isHandActive = false, hands, cameraFeed;

                // ÂàùÂßãÂåñÁªòÂõæ Canvas Â∞∫ÂØ∏
                function resizeOverlay() {
                    overlayCanvas.width = 320; 
                    overlayCanvas.height = 240; 
                }
                resizeOverlay();

                window.onHandResults = function(results) {
                    loadingBar.style.width = '0%';
                    
                    // --- 1. ÁªòÂà∂È™®È™º ---
                    ctxOverlay.save();
                    ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    if (results.multiHandLandmarks) {
                        for (const landmarks of results.multiHandLandmarks) {
                            // ÁªòÂà∂ËøûÁ∫ø
                            drawConnectors(ctxOverlay, landmarks, HAND_CONNECTIONS, {color: '#50ffff', lineWidth: 2});
                            // ÁªòÂà∂ËäÇÁÇπ
                            drawLandmarks(ctxOverlay, landmarks, {color: '#ffc8f5', lineWidth: 1, radius: 2});
                        }
                    }
                    ctxOverlay.restore();

                    // --- 2. Áâ©ÁêÜÈÄªËæë ---
                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        const lm = results.multiHandLandmarks[0];
                        const dist = Math.hypot(lm[4].x - lm[20].x, lm[4].y - lm[20].y);
                        const palm = Math.hypot(lm[0].x - lm[9].x, lm[0].y - lm[9].y);
                        const openness = dist / (palm * 1.6);
                        if (openness < 0.3) targetExpansion = -0.8;
                        else if (openness > 0.85) targetExpansion = 1.2;
                        else targetExpansion = (openness - 0.3) * 1.5; 
                    } else targetExpansion = 0;
                }

                window.toggleHand = async function() {
                    if (!isHandActive) {
                        showToast("üß† NEURAL LINK INITIALIZING...");
                        loadingBar.style.width = '30%';
                        hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                        hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5});
                        hands.onResults(window.onHandResults);
                        cameraFeed = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 320, height: 240 });
                        loadingBar.style.width = '60%';
                        await cameraFeed.start();
                        loadingBar.style.width = '100%';
                        setTimeout(()=>loadingBar.style.width='0%', 500);
                        cameraBox.classList.add('active'); handBtn.classList.add('active'); isHandActive = true;
                        showToast("üñêÔ∏è HAND CONTROL ACTIVE");
                    } else {
                        if(videoElement.srcObject) videoElement.srcObject.getTracks().forEach(t=>t.stop());
                        videoElement.srcObject = null;
                        cameraBox.classList.remove('active'); handBtn.classList.remove('active'); isHandActive = false; targetExpansion = 0;
                        // Ê∏ÖÁ©∫ÁªòÂõæ
                        ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                        showToast("üîå NEURAL LINK OFF");
                    }
                }
                handBtn.addEventListener('click', window.toggleHand);
            }

            // --- Áâ©ÁêÜÂºïÊìé ---
            class Star {
                constructor() { this.reset(); this.angle = Math.random() * Math.PI * 2; }
                reset() {
                    const limit = Math.sqrt(cw*cw + ch*ch) / 2;
                    this.r = Math.random() * limit + 50; this.baseR = this.r;
                    this.orbitalSpeed = (Math.random() * 0.5 + 0.5) * 0.005;
                    this.baseSize = Math.random() * 2 + 0.5; this.size = this.baseSize;
                    this.x = cw/2 + Math.cos(this.angle) * this.r;
                    this.y = ch/2 + Math.sin(this.angle) * this.r;
                    this.vx = 0; this.vy = 0;
                    const ratio = (this.r - 50) / limit;
                    this.baseColor = { r: 200+Math.floor(55*ratio), g: 200-Math.floor(100*ratio), b: 255, a: Math.random()*0.8+0.2 };
                    this.hue = Math.random() * 360;
                }
                update() {
                    this.angle += this.orbitalSpeed * warpSpeed * globalSpeed;
                    
                    let expansionFactor = 1 + handExpansion * 1.5;
                    let targetR = this.baseR * expansionFactor;
                    let tx = cw/2 + Math.cos(this.angle) * targetR;
                    let ty = ch/2 + Math.sin(this.angle) * targetR;

                    if (handExpansion > 0.8) {
                        const jitter = handExpansion * 8;
                        tx += (Math.random() - 0.5) * jitter;
                        ty += (Math.random() - 0.5) * jitter;
                    }

                    let ax = (tx - this.x) * (0.05 + Math.abs(handExpansion)*0.02);
                    let ay = (ty - this.y) * (0.05 + Math.abs(handExpansion)*0.02);
                    
                    if (isSucking) {
                        let dx = rawMx - this.x, dy = rawMy - this.y;
                        let distSq = dx*dx + dy*dy;
                        let force = 2000 / (distSq + 100);
                        ax += dx * force; ay += dy * force;
                    }

                    this.vx += ax; this.vy += ay;
                    this.vx *= 0.9; this.vy *= 0.9;
                    this.x += this.vx; this.y += this.vy;

                    let dist = 1 - handExpansion * 0.7; 
                    if(dist < 0.1) dist = 0.1;
                    let brightness = 1 / (dist * dist);
                    this.size = this.baseSize * (1 / dist);

                    if (handExpansion > 0.5) {
                        this.renderColor = `rgba(255, 255, 255, ${Math.min(1, brightness * 0.5)})`;
                    } else {
                        let alpha = this.baseColor.a * Math.min(1, brightness);
                        this.renderColor = `rgba(${this.baseColor.r}, ${this.baseColor.g}, ${this.baseColor.b}, ${alpha})`;
                    }

                    if (this.x < -cw || this.x > cw*2 || this.y < -ch || this.y > ch*2 || isNaN(this.x)) this.reset();
                }
                draw() {
                    let dx = this.x - mx * 30; let dy = this.y - my * 30;
                    if (isSucking) {
                        let d2Hole = (dx - rawMx)**2 + (dy - rawMy)**2;
                        if (d2Hole < 400) { this.reset(); return; }
                    }
                    ctx.beginPath(); ctx.arc(dx, dy, this.size, 0, Math.PI * 2);
                    if (rainbowMode) { this.hue+=2; ctx.fillStyle = `hsla(${this.hue}, 100%, 70%, 0.8)`; }
                    else ctx.fillStyle = this.renderColor;
                    ctx.fill();
                }
            }
            
            const PARTICLE_COUNT = isMobile ? 600 : 1200;
            const stars = []; for (let i = 0; i < PARTICLE_COUNT; i++) stars.push(new Star());

            function showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2500);
            }
            
            document.addEventListener('wheel', e => { globalSpeed -= e.deltaY * 0.001; if(globalSpeed>5)globalSpeed=5; if(globalSpeed<-2)globalSpeed=-2; 
                document.getElementById('speed-text').innerText=`TIME: ${globalSpeed.toFixed(2)}x`;
                document.getElementById('speed-bar').style.width = `${Math.max(0,Math.min(100, (globalSpeed+2)/7*100))}%`;
            }, {passive:false});
            
            document.addEventListener('mousedown', e => { if(e.target.closest('.icon-btn')||e.target.closest('#context-menu')||e.target.closest('#avatar-btn'))return; if(e.button===0) isSucking=true; });
            document.addEventListener('mouseup', () => isSucking=false);
            
            document.addEventListener('touchstart', e => { 
                if(e.target.closest('.icon-btn')||e.target.closest('.btn')||e.target.closest('#avatar-btn'))return; 
                if(e.touches.length===1) isSucking=true; 
            }, {passive:false});
            document.addEventListener('touchend', () => isSucking=false);

            document.getElementById('avatar-btn').addEventListener('click', e => {
                e.stopPropagation(); if(isWarping) return;
                isWarping = true; document.getElementById('avatar-btn').classList.add('warp-active'); document.getElementById('avatar-img').classList.add('spin-warp');
                let t = setInterval(()=>{if(warpSpeed<20)warpSpeed+=1},50); showToast("‚ö° WARP ENGAGED");
                setTimeout(()=>{ clearInterval(t); const d = setInterval(()=>{if(warpSpeed>1)warpSpeed-=1;else{warpSpeed=1;isWarping=false;document.getElementById('avatar-btn').classList.remove('warp-active');document.getElementById('avatar-img').classList.remove('spin-warp');clearInterval(d)}},50) }, 2500);
            });

            const ctxMenu = document.getElementById('context-menu');
            document.addEventListener('contextmenu', e => {
                e.preventDefault(); e.stopPropagation();
                if(!isMobile) {
                    ctxMenu.style.left = (e.clientX - 80) + 'px'; ctxMenu.style.top = (e.clientY - 80) + 'px'; ctxMenu.classList.add('visible');
                }
            });
            document.addEventListener('click', e => { if(!e.target.closest('#context-menu')) ctxMenu.classList.remove('visible'); });
            document.getElementById('ctx-warp').onclick = () => { document.getElementById('avatar-btn').click(); ctxMenu.classList.remove('visible'); };
            document.getElementById('ctx-rgb').onclick = () => { rainbowMode = !rainbowMode; showToast(rainbowMode?"üåà RGB: ON":"üåë RGB: OFF"); ctxMenu.classList.remove('visible'); };
            document.getElementById('ctx-freeze').onclick = () => { globalSpeed=0; showToast("‚ùÑÔ∏è FROZEN"); ctxMenu.classList.remove('visible'); };
            document.getElementById('ctx-reset').onclick = () => { globalSpeed=1; rainbowMode=false; showToast("‚ôªÔ∏è RESET"); ctxMenu.classList.remove('visible'); };

            if(!isMobile) {
                const kCode = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
                let kIdx = 0;
                document.addEventListener('keydown', e => {
                    if(e.key === kCode[kIdx]) {
                        if(kIdx===0) document.getElementById('konami-hint').classList.add('typing-active');
                        document.querySelectorAll('kbd')[kIdx].classList.add('active'); kIdx++;
                        if(kIdx===kCode.length) { rainbowMode=!rainbowMode; showToast(rainbowMode?"üåà RGB: ON":"üåë RGB: OFF"); setTimeout(()=>{kIdx=0;document.querySelectorAll('kbd').forEach(k=>k.classList.remove('active'));document.getElementById('konami-hint').classList.remove('typing-active')},800); }
                    } else { if(kIdx>0) { kIdx=0; document.querySelectorAll('kbd').forEach(k=>k.classList.remove('active')); document.getElementById('konami-hint').classList.remove('typing-active'); } }
                });
            }

            function loop() {
                handExpansion += (targetExpansion - handExpansion) * 0.1;
                ctx.globalCompositeOperation = 'destination-out';
                let alpha = (isWarping || Math.abs(globalSpeed) > 2 || handExpansion > 0.5) ? 0.1 : 0.15;
                ctx.fillStyle = `rgba(0, 0, 0, ${alpha})`;
                ctx.fillRect(0, 0, cw, ch);

                ctx.globalCompositeOperation = 'lighter';
                stars.forEach(s => { s.update(); s.draw(); });

                if(isSucking) {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.beginPath(); ctx.arc(rawMx, rawMy, 20, 0, Math.PI*2); ctx.fillStyle = '#000'; ctx.fill();
                    ctx.strokeStyle = '#50ffff'; ctx.lineWidth=2; ctx.stroke();
                    ctx.globalCompositeOperation = 'lighter';
                }
                requestAnimFrame(loop);
            }
            loop();
        });
    </script>
</body>
</html>
